<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>全球实时播报</title>
    <style>
      :root{
        /* 更深的护眼深色系 */
        --bg0:#05060d;
        --bg1:#070a16;
        --bg2:#0a1330;

        --card: rgba(255,255,255,.06);
        --card2: rgba(255,255,255,.08);
        --stroke: rgba(255,255,255,.12);
        --stroke2: rgba(255,255,255,.18);

        --text: rgba(255,255,255,.92);
        --muted: rgba(255,255,255,.72);
        --muted2: rgba(255,255,255,.56);

        --ok: #67e8f9;
        --err: #fb7185;
        --warn:#fbbf24;

        --btn: #7c3aed;
        --btn2:#4f46e5;

        --shadow: 0 18px 50px rgba(0,0,0,.58);
        --r: 18px;

        /* 大字/大按钮（适合老人） */
        --fs: 18px;
        --fs-title: 22px;
        --fs-sub: 13px;

        --ctl-h: 46px;
        --btn-h: 46px;

        --item-title: 20px;
        --item-meta: 14px;
      }

      *{ box-sizing: border-box; }
      html, body { height: 100%; }
      body{
        margin:0;
        min-height:100vh;
        color:var(--text);
        font: var(--fs)/1.65 system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
        background:
          radial-gradient(1000px 600px at 15% -10%, rgba(124,58,237,.35), transparent 60%),
          radial-gradient(900px 500px at 70% 0%, rgba(79,70,229,.28), transparent 55%),
          radial-gradient(900px 650px at 40% 120%, rgba(103,232,249,.14), transparent 62%),
          linear-gradient(180deg, var(--bg0), var(--bg1) 50%, var(--bg2));
      }

      .wrap{ max-width: 1100px; margin: 22px auto; padding: 0 16px 56px; }
      header{
        display:flex; align-items:center; gap:14px;
        padding: 10px 4px 16px;
      }
      .logo{
        width:42px; height:42px; border-radius: 14px;
        background:
          radial-gradient(circle at 30% 20%, rgba(255,255,255,.9), rgba(255,255,255,.06) 45%),
          linear-gradient(135deg, rgba(103,232,249,.75), rgba(124,58,237,.85));
        box-shadow: 0 10px 30px rgba(124,58,237,.20);
      }
      h1{ margin:0; font-size: var(--fs-title); letter-spacing: .4px; }
      .sub{ margin-top: 2px; color: var(--muted2); font-size: var(--fs-sub); }

      .panel{
        display:flex; flex-wrap: wrap; gap: 12px;
        align-items: end;
        padding: 14px;
        background: rgba(255,255,255,.05);
        border: 1px solid var(--stroke);
        border-radius: var(--r);
        box-shadow: var(--shadow);
        backdrop-filter: blur(14px);
      }
      .field{ display:flex; flex-direction: column; gap: 8px; min-width: 200px; }
      .field.wide{ flex: 1 1 480px; min-width: 280px; }
      label{ color: var(--muted); font-size: 14px; }

      select, input{
        height: var(--ctl-h);
        border-radius: 14px;
        border: 1px solid var(--stroke2);
        outline: none;
        background: rgba(0,0,0,.22);
        color: var(--text);
        padding: 0 14px;
        font-size: 16px;
      }
      input::placeholder{ color: rgba(255,255,255,.35); }
      select:focus, input:focus{
        border-color: rgba(103,232,249,.55);
        box-shadow: 0 0 0 4px rgba(103,232,249,.10);
      }

      .actions{ display:flex; gap: 10px; align-items:center; }
      button{
        height: var(--btn-h);
        padding: 0 16px;
        border-radius: 14px;
        border: 1px solid rgba(124,58,237,.45);
        background: linear-gradient(135deg, var(--btn), var(--btn2));
        color: white;
        font-weight: 700;
        font-size: 16px;
        cursor: pointer;
        box-shadow: 0 14px 34px rgba(79,70,229,.16);
      }
      button:disabled{ opacity: .6; cursor: not-allowed; }

      .status{
        margin-top: 14px;
        padding: 12px 14px;
        border-radius: var(--r);
        border: 1px solid var(--stroke);
        background: rgba(0,0,0,.22);
        backdrop-filter: blur(12px);
        display:flex; gap: 10px; align-items: center; flex-wrap: wrap;
      }
      .dot{
        width: 10px; height: 10px; border-radius: 999px;
        background: rgba(255,255,255,.35);
      }
      .dot.ok{ background: var(--ok); }
      .dot.err{ background: var(--err); }
      .dot.warn{ background: var(--warn); }
      .status strong{ font-weight: 800; }
      .muted{ color: var(--muted2); }

      .list{
        margin-top: 14px;
        display:grid;
        grid-template-columns: 1fr; /* 每一排只显示一条 */
        gap: 12px;
      }

      /* 条纹式大卡片：整行更大更易读 */
      .item{
        padding: 16px 16px 14px;
        border-radius: var(--r);
        border: 1px solid rgba(255,255,255,.12);
        background:
          linear-gradient(90deg, rgba(103,232,249,.14), transparent 18%),
          rgba(255,255,255,.05);
        backdrop-filter: blur(12px);
        box-shadow: 0 12px 36px rgba(0,0,0,.30);
      }

      .item a{
        display:block;
        color: var(--text);
        text-decoration: none;
        font-size: var(--item-title);
        font-weight: 750;
        line-height: 1.5;
        letter-spacing: .2px;
      }
      .item a:hover{ text-decoration: underline; }

      .meta{
        margin-top: 10px;
        color: var(--muted2);
        font-size: var(--item-meta);
        display:flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items:center;
      }
      .pill{
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,.14);
        background: rgba(0,0,0,.18);
      }

      .foot{
        margin-top: 12px;
        color: var(--muted2);
        font-size: 13px;
      }

      @media (max-width: 520px){
        :root{
          --fs: 17px;
          --item-title: 19px;
        }
        .field{ min-width: 160px; }
        .field.wide{ min-width: 240px; }
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <header>
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>全球实时播报</h1>
          <div class="sub">GitHub Pages 静态部署 · 自动刷新 · 点击直达原文 · 数据源：GDELT</div>
        </div>
      </header>

      <div class="panel">
        <div class="field">
          <label for="scope">范围</label>
          <select id="scope">
            <option value="zh" selected>中文来源（推荐）</option>
            <option value="en">英文来源</option>
            <option value="all">全部来源</option>
          </select>
        </div>

        <div class="field wide">
          <label for="kw">关键字</label>
          <input id="kw" placeholder="例如：中东 / AI / 经济（用空格或 / 分隔）" />
        </div>

        <div class="field">
          <label for="max">条数</label>
          <select id="max">
            <option>10</option>
            <option selected>30</option>
            <option>50</option>
            <option>100</option>
          </select>
        </div>

        <div class="field">
          <label for="interval">刷新</label>
          <select id="interval">
            <option value="0">关闭</option>
            <option value="15" selected>15 秒</option>
            <option value="30">30 秒</option>
            <option value="60">60 秒</option>
            <option value="120">120 秒</option>
          </select>
        </div>

        <div class="actions">
          <button id="refreshBtn">立即刷新</button>
        </div>
      </div>

      <div class="status">
        <div id="dot" class="dot"></div>
        <div id="statusText"><strong>就绪</strong> <span class="muted">· 等待刷新</span></div>
        <div class="muted" id="updatedAt" style="margin-left:auto;"></div>
      </div>

      <div class="list" id="list"></div>

      <div class="foot muted">
        提示：如果出现 “Query OR clause too short” 类报错，通常是关键词里包含过短的英文词（如 AI）；本页面会自动忽略或展开它们。
      </div>
    </div>

    <script>
      const scopeEl = document.getElementById("scope");
      const kwEl = document.getElementById("kw");
      const maxEl = document.getElementById("max");
      const intervalEl = document.getElementById("interval");
      const refreshBtn = document.getElementById("refreshBtn");
      const listEl = document.getElementById("list");
      const statusTextEl = document.getElementById("statusText");
      const dotEl = document.getElementById("dot");
      const updatedAtEl = document.getElementById("updatedAt");

      let inflight = null;
      let timer = null;
      let lastIgnored = [];

      function setStatus(html, level) {
        const lvl = level || "idle";
        dotEl.className = "dot" + (lvl === "ok" ? " ok" : lvl === "error" ? " err" : lvl === "warn" ? " warn" : "");
        statusTextEl.innerHTML = String(html || "");
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function savePrefs() {
        const prefs = {
          scope: scopeEl.value,
          kw: kwEl.value,
          max: maxEl.value,
          interval: intervalEl.value,
        };
        localStorage.setItem("gb:prefs", JSON.stringify(prefs));
      }

      function loadPrefs() {
        try {
          const raw = localStorage.getItem("gb:prefs");
          if (!raw) return;
          const p = JSON.parse(raw);
          if (p.scope) scopeEl.value = p.scope;
          if (typeof p.kw === "string") kwEl.value = p.kw;
          if (p.max) maxEl.value = p.max;
          if (p.interval) intervalEl.value = p.interval;
        } catch {}
      }

      function gdeltDateTime(d) {
        const pad = (n) => String(n).padStart(2, "0");
        const yyyy = d.getUTCFullYear();
        const mm = pad(d.getUTCMonth() + 1);
        const dd = pad(d.getUTCDate());
        const HH = pad(d.getUTCHours());
        const MM = pad(d.getUTCMinutes());
        const SS = pad(d.getUTCSeconds());
        return `${yyyy}${mm}${dd}${HH}${MM}${SS}`;
      }

      // 修复 “Invalid Date”：兼容 GDELT 的 seendate 格式
      function parseGdeltSeendate(value) {
        if (!value) return null;
        const s = String(value).trim();

        // 20260113185008
        if (/^\d{14}$/.test(s)) {
          const y = +s.slice(0, 4);
          const mo = +s.slice(4, 6) - 1;
          const d = +s.slice(6, 8);
          const h = +s.slice(8, 10);
          const mi = +s.slice(10, 12);
          const se = +s.slice(12, 14);
          return new Date(Date.UTC(y, mo, d, h, mi, se));
        }

        // 2026-01-13 18:50:08 或 2026-01-13T18:50:08
        const m = s.match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2}):(\d{2})/);
        if (m) {
          return new Date(Date.UTC(+m[1], +m[2] - 1, +m[3], +m[4], +m[5], +m[6]));
        }

        const d = new Date(s);
        if (!Number.isNaN(d.getTime())) return d;
        return null;
      }

      function formatTime(dt) {
        const d = dt instanceof Date ? dt : parseGdeltSeendate(dt);
        if (!d || Number.isNaN(d.getTime())) return "";
        return d.toLocaleString();
      }

      function normalizeKeywords(rawKw) {
        const ignored = [];
        const mapped = [];

        const chunks = String(rawKw || "")
          .split(/[\/|,，\s]+/)
          .map((s) => s.trim())
          .filter(Boolean);

        for (const t0 of chunks) {
          const t = t0.replaceAll("“", '"').replaceAll("”", '"').trim();
          const upper = t.toUpperCase();

          // 展开常见短词（避免 GDELT 报 "Query OR clause too short"）
          if (upper === "AI") {
            mapped.push("artificial intelligence");
            continue;
          }

          // 过滤纯英文/数字且太短的 token（例如 AI/US/UK）
          if (/^[A-Za-z0-9]+$/.test(t) && t.length < 3) {
            ignored.push(t);
            continue;
          }

          mapped.push(t);
        }

        return { terms: mapped, ignored };
      }

      function buildScopeQuery(scope) {
        if (scope === "zh") return "sourcelang:Chinese";
        if (scope === "en") return "sourcelang:English";
        return "";
      }

      function buildGdeltUrl() {
        const endpoint = "https://api.gdeltproject.org/api/v2/doc/doc";
        const url = new URL(endpoint);

        const scopeQuery = buildScopeQuery(scopeEl.value);
        const { terms, ignored } = normalizeKeywords(kwEl.value);
        lastIgnored = ignored;

        const quoted = terms.map((t) => `"${t.replaceAll('"', "")}"`).filter(Boolean);
        const kwQuery = quoted.length ? `(${quoted.join(" OR ")})` : "";

        const query = [kwQuery, scopeQuery].filter(Boolean).join(" ").trim();
        url.searchParams.set("query", query || "sourcelang:Chinese");

        // 最近 24 小时（需要更“实时”可改 6 或 12）
        const hours = 24;
        const end = new Date();
        const start = new Date(Date.now() - hours * 3600 * 1000);
        url.searchParams.set("startdatetime", gdeltDateTime(start));
        url.searchParams.set("enddatetime", gdeltDateTime(end));

        url.searchParams.set("mode", "ArtList");
        url.searchParams.set("format", "json");
        url.searchParams.set("sort", "datedesc");
        url.searchParams.set("maxrecords", String(parseInt(maxEl.value, 10) || 30));

        return url.toString();
      }

      function render(items) {
        if (!items.length) {
          listEl.innerHTML = `<div class="item"><div class="muted">暂无结果</div></div>`;
          return;
        }

        listEl.innerHTML = items
          .map((x) => {
            const title = escapeHtml(x.title || "(无标题)");
            const url = escapeHtml(x.url || "");
            const domain = escapeHtml(x.domain || "");
            const country = escapeHtml(x.sourceCountry || "");
            const seen = x.seendate || "";
            const t = formatTime(seen);

            return `
              <div class="item">
                <a href="${url}" target="_blank" rel="noopener noreferrer">${title}</a>
                <div class="meta">
                  ${domain ? `<span class="pill">${domain}</span>` : ""}
                  ${country ? `<span class="pill">${country}</span>` : ""}
                  ${t ? `<span class="pill">${escapeHtml(t)}</span>` : ""}
                </div>
              </div>
            `;
          })
          .join("");
      }

      function restartTimer() {
        if (timer) {
          clearInterval(timer);
          timer = null;
        }
        const sec = parseInt(intervalEl.value, 10) || 0;
        if (sec > 0) timer = setInterval(() => refresh(), sec * 1000);
      }

      async function refresh() {
        savePrefs();
        if (inflight) inflight.abort();
        inflight = new AbortController();

        updatedAtEl.textContent = "";
        setStatus(`<strong>正在获取最新播报…</strong> <span class="muted">· loading</span>`, "warn");
        refreshBtn.disabled = true;

        try {
          const url = buildGdeltUrl();
          const res = await fetch(url, { signal: inflight.signal, cache: "no-store" });
          const raw = await res.text();

          if (!res.ok) throw new Error(`GDELT ${res.status}: ${raw.slice(0, 240)}`);

          const t = raw.trimStart();
          if (!(t.startsWith("{") || t.startsWith("["))) {
            throw new Error(`GDELT返回不是JSON：${raw.slice(0, 240)}`);
          }

          let data;
          try {
            data = JSON.parse(raw);
          } catch {
            throw new Error(`GDELT返回不是JSON：${raw.slice(0, 240)}`);
          }

          const items = Array.isArray(data.articles) ? data.articles : [];
          const filtered = items
            .map((x) => ({
              title: x.title,
              url: x.url,
              domain: x.domain,
              sourceCountry: x.sourceCountry,
              seendate: x.seendate,
            }))
            .filter((x) => x.url);

          render(filtered);

          const ignoredTip = lastIgnored.length
            ? ` <span class="muted">· 已忽略过短关键词：${escapeHtml(lastIgnored.join(", "))}</span>`
            : "";

          setStatus(`<strong>已更新：${filtered.length} 条</strong> <span class="muted">· ok</span>${ignoredTip}`, "ok");
          updatedAtEl.textContent = `更新时间：${formatTime(new Date())}`;
        } catch (e) {
          if (e && e.name === "AbortError") return;
          const msg = (e && e.message) ? e.message : String(e);
          setStatus(
            `<strong>请求失败：</strong> ${escapeHtml(msg)} <span class="muted">· 如果是 CORS 报错，需要加前端代理（GitHub Pages 无法跑后端）</span>`,
            "error"
          );
        } finally {
          refreshBtn.disabled = false;
        }
      }

      // init
      loadPrefs();
      restartTimer();
      refresh();

      scopeEl.addEventListener("change", () => { savePrefs(); refresh(); });
      maxEl.addEventListener("change", () => { savePrefs(); refresh(); });
      intervalEl.addEventListener("change", () => { savePrefs(); restartTimer(); });
      refreshBtn.addEventListener("click", () => refresh());

      // 回车刷新
      kwEl.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter") refresh();
      });

      // 输入停顿后刷新（防抖）
      let kwDebounce = null;
      kwEl.addEventListener("input", () => {
        savePrefs();
        if (kwDebounce) clearTimeout(kwDebounce);
        kwDebounce = setTimeout(() => refresh(), 600);
      });
    </script>
  </body>
</html>
