<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>全球实时播报</title>
    <meta name="description" content="全球实时新闻播报（大字护眼版）：只显示10条，30秒轮转一条，新消息永远置顶。" />
    <style>
      :root{
        /* 护眼深色 */
        --bg0:#04050b;
        --bg1:#070a16;
        --bg2:#0a1330;

        --card: rgba(255,255,255,.05);
        --stroke: rgba(255,255,255,.12);
        --stroke2: rgba(255,255,255,.18);

        --text: rgba(255,255,255,.92);
        --muted: rgba(255,255,255,.70);
        --muted2: rgba(255,255,255,.56);

        --ok: #67e8f9;
        --err:#fb7185;
        --warn:#fbbf24;

        --btn:#7c3aed;
        --btn2:#4f46e5;

        --shadow: 0 18px 50px rgba(0,0,0,.58);
        --r: 18px;

        /* 默认字号（可被“字体模式”覆盖） */
        --fs: 18px;
        --fs-title: 22px;
        --fs-sub: 13px;

        --ctl-h: 46px;
        --btn-h: 46px;

        --item-title: 22px;
        --item-meta: 14px;

        --pad: 16px;
      }

      /* 字体模式：标准 / 大字 / 超大字 */
      body[data-font="m"]{
        --fs: 18px;
        --item-title: 22px;
        --item-meta: 14px;
        --ctl-h: 46px;
        --btn-h: 46px;
        --pad: 16px;
      }
      body[data-font="l"]{
        --fs: 20px;
        --item-title: 26px;
        --item-meta: 16px;
        --ctl-h: 52px;
        --btn-h: 52px;
        --pad: 18px;
      }
      body[data-font="xl"]{
        --fs: 22px;
        --item-title: 30px;
        --item-meta: 18px;
        --ctl-h: 58px;
        --btn-h: 58px;
        --pad: 20px;
      }

      *{ box-sizing: border-box; }
      html, body { height: 100%; }
      body{
        margin:0;
        min-height:100vh;
        color:var(--text);
        font: var(--fs)/1.7 system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
        background:
          radial-gradient(1000px 600px at 15% -10%, rgba(124,58,237,.35), transparent 60%),
          radial-gradient(900px 500px at 70% 0%, rgba(79,70,229,.28), transparent 55%),
          radial-gradient(900px 650px at 40% 120%, rgba(103,232,249,.14), transparent 62%),
          linear-gradient(180deg, var(--bg0), var(--bg1) 50%, var(--bg2));
      }

      .wrap{ max-width: 1100px; margin: 22px auto; padding: 0 16px 56px; }
      header{
        display:flex; align-items:center; gap:14px;
        padding: 10px 4px 16px;
      }
      .logo{
        width:42px; height:42px; border-radius: 14px;
        background:
          radial-gradient(circle at 30% 20%, rgba(255,255,255,.9), rgba(255,255,255,.06) 45%),
          linear-gradient(135deg, rgba(103,232,249,.75), rgba(124,58,237,.85));
        box-shadow: 0 10px 30px rgba(124,58,237,.20);
        flex: 0 0 auto;
      }
      h1{ margin:0; font-size: var(--fs-title); letter-spacing: .4px; }
      .sub{ margin-top: 2px; color: var(--muted2); font-size: var(--fs-sub); }

      .panel{
        display:flex; flex-wrap: wrap; gap: 12px;
        align-items: end;
        padding: 14px;
        background: rgba(255,255,255,.05);
        border: 1px solid var(--stroke);
        border-radius: var(--r);
        box-shadow: var(--shadow);
        backdrop-filter: blur(14px);
      }

      .field{ display:flex; flex-direction: column; gap: 8px; min-width: 200px; }
      .field.wide{ flex: 1 1 480px; min-width: 280px; }
      label{ color: var(--muted); font-size: 14px; }

      select, input{
        height: var(--ctl-h);
        border-radius: 14px;
        border: 1px solid var(--stroke2);
        outline: none;
        background: rgba(0,0,0,.22);
        color: var(--text);
        padding: 0 14px;
        font-size: 16px;
      }
      input::placeholder{ color: rgba(255,255,255,.35); }
      select:focus, input:focus{
        border-color: rgba(103,232,249,.55);
        box-shadow: 0 0 0 4px rgba(103,232,249,.10);
      }

      .actions{ display:flex; gap: 10px; align-items:center; flex-wrap: wrap; }
      button{
        height: var(--btn-h);
        padding: 0 16px;
        border-radius: 14px;
        border: 1px solid rgba(124,58,237,.45);
        background: linear-gradient(135deg, var(--btn), var(--btn2));
        color: white;
        font-weight: 800;
        font-size: 16px;
        cursor: pointer;
        box-shadow: 0 14px 34px rgba(79,70,229,.16);
      }
      button.secondary{
        background: rgba(0,0,0,.22);
        border: 1px solid rgba(255,255,255,.18);
        box-shadow: none;
        font-weight: 700;
      }
      button:disabled{ opacity: .6; cursor: not-allowed; }

      .seg{
        display:flex;
        border: 1px solid rgba(255,255,255,.18);
        background: rgba(0,0,0,.22);
        border-radius: 14px;
        overflow:hidden;
      }
      .seg button{
        height: var(--btn-h);
        border-radius: 0;
        border: 0;
        background: transparent;
        box-shadow: none;
        padding: 0 12px;
        font-weight: 800;
      }
      .seg button.active{
        background: rgba(255,255,255,.10);
      }

      .status{
        margin-top: 14px;
        padding: 12px 14px;
        border-radius: var(--r);
        border: 1px solid var(--stroke);
        background: rgba(0,0,0,.22);
        backdrop-filter: blur(12px);
        display:flex; gap: 10px; align-items: center; flex-wrap: wrap;
      }
      .dot{
        width: 10px; height: 10px; border-radius: 999px;
        background: rgba(255,255,255,.35);
      }
      .dot.ok{ background: var(--ok); }
      .dot.err{ background: var(--err); }
      .dot.warn{ background: var(--warn); }
      .status strong{ font-weight: 900; }
      .muted{ color: var(--muted2); }

      /* 每排一条：条纹大卡片 */
      .list{
        margin-top: 14px;
        display:grid;
        grid-template-columns: 1fr;
        gap: 12px;
      }
      .item{
        padding: var(--pad);
        border-radius: var(--r);
        border: 1px solid rgba(255,255,255,.12);
        background:
          linear-gradient(90deg, rgba(103,232,249,.16), transparent 18%),
          rgba(255,255,255,.05);
        backdrop-filter: blur(12px);
        box-shadow: 0 12px 36px rgba(0,0,0,.30);
        position: relative;
        overflow:hidden;
      }
      .item[data-new="1"]{
        border-color: rgba(103,232,249,.35);
        box-shadow: 0 16px 44px rgba(103,232,249,.10);
      }
      .item a{
        display:block;
        color: var(--text);
        text-decoration: none;
        font-size: var(--item-title);
        font-weight: 900;
        line-height: 1.45;
        letter-spacing: .2px;
      }
      .item a:hover{ text-decoration: underline; }

      .meta{
        margin-top: 10px;
        color: var(--muted2);
        font-size: var(--item-meta);
        display:flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items:center;
      }
      .pill{
        padding: 4px 10px;
        border-radius: 999px;
        border: 1px solid rgba(255,255,255,.14);
        background: rgba(0,0,0,.18);
      }

      .foot{
        margin-top: 12px;
        color: var(--muted2);
        font-size: 13px;
      }

      @media (prefers-reduced-motion: reduce) {
        * { scroll-behavior: auto !important; }
      }
      @media (max-width: 520px){
        .field{ min-width: 160px; }
        .field.wide{ min-width: 240px; }
      }
    </style>
  </head>

  <body data-font="l">
    <div class="wrap">
      <header>
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>全球实时播报（10条轮播）</h1>
          <div class="sub">每 30 秒置顶一条新标题 · 点击直达原文 · 数据源：GDELT</div>
        </div>
      </header>

      <div class="panel">
        <div class="field">
          <label for="scope">范围</label>
          <select id="scope">
            <option value="zh" selected>中文来源（推荐）</option>
            <option value="en">英文来源</option>
            <option value="all">全部来源</option>
          </select>
        </div>

        <div class="field wide">
          <label for="kw">关键字</label>
          <input id="kw" placeholder="例如：中东 / 经济 / AI（用空格或 / 分隔）" />
        </div>

        <div class="field">
          <label for="rotate">轮播</label>
          <select id="rotate">
            <option value="15">15 秒/条</option>
            <option value="30" selected>30 秒/条</option>
            <option value="60">60 秒/条</option>
            <option value="0">关闭轮播</option>
          </select>
        </div>

        <div class="actions">
          <button id="refreshBtn" title="立即从GDELT拉取新数据">立即刷新</button>
          <button id="nextBtn" class="secondary" title="手动置顶一条新标题">下一条（置顶）</button>

          <div class="seg" aria-label="字体大小">
            <button id="fontM" type="button">标准</button>
            <button id="fontL" type="button" class="active">大字</button>
            <button id="fontXL" type="button">超大字</button>
          </div>
        </div>
      </div>

      <div class="status">
        <div id="dot" class="dot"></div>
        <div id="statusText"><strong>就绪</strong> <span class="muted">· 等待刷新</span></div>
        <div class="muted" id="updatedAt" style="margin-left:auto;"></div>
      </div>

      <div class="list" id="list"></div>

      <div class="foot muted">
        说明：页面只展示 10 条；每次轮播会把“新标题”放到第一条，旧的自动往下挤掉。关键词里如果有过短英文（如 AI/US），会自动忽略或展开，避免接口报错。
      </div>
    </div>

    <script>
      const PREF_KEY = "gb:prefs:v2";

      const DISPLAY_COUNT = 10;
      const FETCH_MAX = 50; // 拉取更多做缓冲，展示固定10条

      const scopeEl = document.getElementById("scope");
      const kwEl = document.getElementById("kw");
      const rotateEl = document.getElementById("rotate");
      const refreshBtn = document.getElementById("refreshBtn");
      const nextBtn = document.getElementById("nextBtn");

      const listEl = document.getElementById("list");
      const statusTextEl = document.getElementById("statusText");
      const dotEl = document.getElementById("dot");
      const updatedAtEl = document.getElementById("updatedAt");

      const fontMBtn = document.getElementById("fontM");
      const fontLBtn = document.getElementById("fontL");
      const fontXLBtn = document.getElementById("fontXL");

      let inflight = null;
      let rotateTimer = null;
      let typingDebounce = null;

      // buffer：候选新闻池；shown：当前显示10条；known：去重
      let buffer = [];
      let shown = [];
      const knownUrls = new Set();

      let lastIgnored = [];

      function setStatus(html, level) {
        const lvl = level || "idle";
        dotEl.className = "dot" + (lvl === "ok" ? " ok" : lvl === "error" ? " err" : lvl === "warn" ? " warn" : "");
        statusTextEl.innerHTML = String(html || "");
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function savePrefs() {
        const prefs = {
          scope: scopeEl.value,
          kw: kwEl.value,
          rotate: rotateEl.value,
          font: document.body.dataset.font || "l"
        };
        localStorage.setItem(PREF_KEY, JSON.stringify(prefs));
      }

      function loadPrefs() {
        try {
          const raw = localStorage.getItem(PREF_KEY);
          if (!raw) return;
          const p = JSON.parse(raw);
          if (p.scope) scopeEl.value = p.scope;
          if (typeof p.kw === "string") kwEl.value = p.kw;
          if (p.rotate) rotateEl.value = p.rotate;
          if (p.font) setFont(p.font);
        } catch {}
      }

      function setFont(mode) {
        const m = (mode === "m" || mode === "l" || mode === "xl") ? mode : "l";
        document.body.dataset.font = m;
        fontMBtn.classList.toggle("active", m === "m");
        fontLBtn.classList.toggle("active", m === "l");
        fontXLBtn.classList.toggle("active", m === "xl");
        savePrefs();
      }

      function gdeltDateTime(d) {
        const pad = (n) => String(n).padStart(2, "0");
        const yyyy = d.getUTCFullYear();
        const mm = pad(d.getUTCMonth() + 1);
        const dd = pad(d.getUTCDate());
        const HH = pad(d.getUTCHours());
        const MM = pad(d.getUTCMinutes());
        const SS = pad(d.getUTCSeconds());
        return `${yyyy}${mm}${dd}${HH}${MM}${SS}`;
      }

      // 修复 Invalid Date：兼容 GDELT 的 seendate
      function parseGdeltSeendate(value) {
        if (!value) return null;
        const s = String(value).trim();

        // 20260113185008
        if (/^\d{14}$/.test(s)) {
          const y = +s.slice(0, 4);
          const mo = +s.slice(4, 6) - 1;
          const d = +s.slice(6, 8);
          const h = +s.slice(8, 10);
          const mi = +s.slice(10, 12);
          const se = +s.slice(12, 14);
          return new Date(Date.UTC(y, mo, d, h, mi, se));
        }

        // 2026-01-13 18:50:08 或 2026-01-13T18:50:08
        const m = s.match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2}):(\d{2})/);
        if (m) {
          return new Date(Date.UTC(+m[1], +m[2] - 1, +m[3], +m[4], +m[5], +m[6]));
        }

        const d = new Date(s);
        if (!Number.isNaN(d.getTime())) return d;
        return null;
      }

      function formatTime(dt) {
        const d = dt instanceof Date ? dt : parseGdeltSeendate(dt);
        if (!d || Number.isNaN(d.getTime())) return "";
        return d.toLocaleString();
      }

      function normalizeKeywords(rawKw) {
        const ignored = [];
        const mapped = [];

        const chunks = String(rawKw || "")
          .split(/[\/|,，\s]+/)
          .map((s) => s.trim())
          .filter(Boolean);

        for (const t0 of chunks) {
          const t = t0.replaceAll("“", '"').replaceAll("”", '"').trim();
          const upper = t.toUpperCase();

          // 展开常见短词（避免 GDELT 报 "Query OR clause too short"）
          if (upper === "AI") {
            mapped.push("artificial intelligence");
            continue;
          }

          // 过滤纯英文/数字且太短的 token（例如 AI/US/UK）
          if (/^[A-Za-z0-9]+$/.test(t) && t.length < 3) {
            ignored.push(t);
            continue;
          }

          mapped.push(t);
        }

        return { terms: mapped, ignored };
      }

      function buildScopeQuery(scope) {
        if (scope === "zh") return "sourcelang:Chinese";
        if (scope === "en") return "sourcelang:English";
        return "";
      }

      function toGdeltTerm(term) {
        const t = String(term || "").trim().replaceAll('"', "");
        if (!t) return null;

        // 多词短语要加引号；但太短的短语可能触发 phrase too short
        const hasSpace = /\s/.test(t);
        if (hasSpace) {
          if (t.length < 3) return null;
          return `"${t}"`;
        }

        // 单个词不加引号（避免 “全球” 这种短语触发 phrase too short）
        return t;
      }

      function buildGdeltUrl() {
        const endpoint = "https://api.gdeltproject.org/api/v2/doc/doc";
        const url = new URL(endpoint);

        const scopeQuery = buildScopeQuery(scopeEl.value);
        const { terms, ignored } = normalizeKeywords(kwEl.value);
        lastIgnored = ignored;

        const gdeltTerms = terms.map(toGdeltTerm).filter(Boolean);
        const kwQuery = gdeltTerms.length ? `(${gdeltTerms.join(" OR ")})` : "";

        // 显式 AND，避免解析歧义
        let query = "";
        if (kwQuery && scopeQuery) query = `${kwQuery} AND ${scopeQuery}`;
        else query = kwQuery || scopeQuery || "sourcelang:Chinese";

        url.searchParams.set("query", query);

        // 最近 24 小时（更“实时”可改 6/12）
        const hours = 24;
        const end = new Date();
        const start = new Date(Date.now() - hours * 3600 * 1000);
        url.searchParams.set("startdatetime", gdeltDateTime(start));
        url.searchParams.set("enddatetime", gdeltDateTime(end));

        url.searchParams.set("mode", "ArtList");
        url.searchParams.set("format", "json");
        url.searchParams.set("sort", "datedesc");
        url.searchParams.set("maxrecords", String(FETCH_MAX));

        return url.toString();
      }

      function articleScore(a) {
        // 用 seendate 排序，越新越大
        const d = parseGdeltSeendate(a.seendate);
        return d ? d.getTime() : 0;
      }

      function simplifyArticles(data) {
        const items = Array.isArray(data?.articles) ? data.articles : [];
        return items
          .map((x) => ({
            title: x.title,
            url: x.url,
            domain: x.domain,
            sourceCountry: x.sourceCountry,
            seendate: x.seendate,
          }))
          .filter((x) => x.url);
      }

      function render() {
        if (!shown.length) {
          listEl.innerHTML = `<div class="item"><div class="muted">暂无结果（点“立即刷新”）</div></div>`;
          return;
        }

        listEl.innerHTML = shown
          .map((x, idx) => {
            const title = escapeHtml(x.title || "(无标题)");
            const url = escapeHtml(x.url || "");
            const domain = escapeHtml(x.domain || "");
            const country = escapeHtml(x.sourceCountry || "");
            const t = formatTime(x.seendate);

            const newAttr = idx === 0 && x.__new ? ` data-new="1"` : "";
            return `
              <div class="item"${newAttr}>
                <a href="${url}" target="_blank" rel="noopener noreferrer">${title}</a>
                <div class="meta">
                  ${domain ? `<span class="pill">${domain}</span>` : ""}
                  ${country ? `<span class="pill">${country}</span>` : ""}
                  ${t ? `<span class="pill">${escapeHtml(t)}</span>` : ""}
                </div>
              </div>
            `;
          })
          .join("");
      }

      function takeNextFromBuffer() {
        // 从 buffer 里找一个没展示过的
        while (buffer.length) {
          const next = buffer.shift();
          if (!next?.url) continue;
          if (shown.some((x) => x.url === next.url)) continue;

          next.__new = true;

          shown.unshift(next);
          if (shown.length > DISPLAY_COUNT) shown = shown.slice(0, DISPLAY_COUNT);

          // 只有第一条保持 new 标记，其它清掉
          for (let i = 1; i < shown.length; i++) shown[i].__new = false;

          render();
          return true;
        }
        return false;
      }

      function resetStateForNewQuery() {
        buffer = [];
        shown = [];
        knownUrls.clear();
        render();
      }

      async function fetchMore() {
        savePrefs();

        if (inflight) inflight.abort();
        inflight = new AbortController();

        updatedAtEl.textContent = "";
        setStatus(`<strong>正在拉取数据…</strong> <span class="muted">· loading</span>`, "warn");
        refreshBtn.disabled = true;
        nextBtn.disabled = true;

        try {
          const url = buildGdeltUrl();
          const res = await fetch(url, { signal: inflight.signal, cache: "no-store" });
          const raw = await res.text();

          if (!res.ok) throw new Error(`GDELT ${res.status}: ${raw.slice(0, 240)}`);

          const t = raw.trimStart();
          if (!(t.startsWith("{") || t.startsWith("["))) {
            throw new Error(`GDELT返回不是JSON：${raw.slice(0, 240)}`);
          }

          let data;
          try {
            data = JSON.parse(raw);
          } catch {
            throw new Error(`GDELT返回不是JSON：${raw.slice(0, 240)}`);
          }

          const fresh = simplifyArticles(data)
            .sort((a, b) => articleScore(b) - articleScore(a));

          // 填充 knownUrls 和 buffer（去重）
          let added = 0;
          for (const it of fresh) {
            if (!it.url) continue;
            if (knownUrls.has(it.url)) continue;
            knownUrls.add(it.url);
            buffer.push(it);
            added++;
          }

          // 初次填满显示区
          if (shown.length === 0) {
            // 先从 buffer 取前 DISPLAY_COUNT 条，按时间新到旧展示
            const seed = [];
            while (seed.length < DISPLAY_COUNT && buffer.length) {
              const it = buffer.shift();
              if (!it?.url) continue;
              seed.push(it);
            }
            shown = seed;
            for (let i = 0; i < shown.length; i++) shown[i].__new = false;
            render();
          }

          const ignoredTip = lastIgnored.length
            ? ` <span class="muted">· 已忽略过短英文：${escapeHtml(lastIgnored.join(", "))}</span>`
            : "";

          setStatus(
            `<strong>已拉取：新增 ${added} 条</strong> <span class="muted">· 缓冲区 ${buffer.length} · 展示 ${shown.length}/10</span>${ignoredTip}`,
            "ok"
          );
          updatedAtEl.textContent = `更新时间：${formatTime(new Date())}`;
        } catch (e) {
          if (e && e.name === "AbortError") return;
          const msg = e?.message ? e.message : String(e);
          setStatus(
            `<strong>请求失败：</strong> ${escapeHtml(msg)} <span class="muted">· 提示：如果出现 Query OR clause too short，说明关键词里有过短英文（如 AI）</span>`,
            "error"
          );
        } finally {
          refreshBtn.disabled = false;
          nextBtn.disabled = false;
        }
      }

      async function rotateOnce() {
        // 置顶一条新标题：优先从 buffer 拿；没有就 fetch 再拿
        const ok = takeNextFromBuffer();
        if (ok) {
          setStatus(`<strong>轮播置顶：1 条</strong> <span class="muted">· 缓冲区 ${buffer.length} · 展示 ${shown.length}/10</span>`, "ok");
          updatedAtEl.textContent = `更新时间：${formatTime(new Date())}`;
          return;
        }

        await fetchMore();
        const ok2 = takeNextFromBuffer();
        if (ok2) {
          setStatus(`<strong>轮播置顶：1 条</strong> <span class="muted">· 缓冲区 ${buffer.length} · 展示 ${shown.length}/10</span>`, "ok");
          updatedAtEl.textContent = `更新时间：${formatTime(new Date())}`;
        } else {
          setStatus(`<strong>暂无可轮播的新标题</strong> <span class="muted">· 稍后再试</span>`, "warn");
        }
      }

      function restartRotateTimer() {
        if (rotateTimer) {
          clearInterval(rotateTimer);
          rotateTimer = null;
        }
        const sec = parseInt(rotateEl.value, 10) || 0;
        if (sec > 0) rotateTimer = setInterval(() => rotateOnce(), sec * 1000);
      }

      function bind() {
        scopeEl.addEventListener("change", async () => {
          resetStateForNewQuery();
          await fetchMore();
          restartRotateTimer();
        });

        rotateEl.addEventListener("change", () => {
          savePrefs();
          restartRotateTimer();
        });

        refreshBtn.addEventListener("click", async () => {
          // 手动刷新：不清空列表，只补充 buffer
          await fetchMore();
        });

        nextBtn.addEventListener("click", async () => {
          await rotateOnce();
        });

        kwEl.addEventListener("keydown", (ev) => {
          if (ev.key === "Enter") {
            resetStateForNewQuery();
            fetchMore();
            return;
          }
        });

        kwEl.addEventListener("input", () => {
          savePrefs();
          if (typingDebounce) clearTimeout(typingDebounce);
          typingDebounce = setTimeout(() => {
            resetStateForNewQuery();
            fetchMore();
          }, 700);
        });

        fontMBtn.addEventListener("click", () => setFont("m"));
        fontLBtn.addEventListener("click", () => setFont("l"));
        fontXLBtn.addEventListener("click", () => setFont("xl"));
      }

      // init
      loadPrefs();
      bind();

      // 初次加载：拉取并填满10条，然后启动轮播
      (async function init() {
        setStatus(`<strong>正在初始化…</strong> <span class="muted">· 首次拉取中</span>`, "warn");
        render();
        await fetchMore();
        restartRotateTimer();
      })();
    </script>
  </body>
</html>
